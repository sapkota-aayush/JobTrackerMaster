{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard | JobSearchMaster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'myapp/css/home.css' %}" />
    <style>
      /* Existing styles */
      .dashboard-header {
        background: #0d3b66;
        color: #fff;
        border-radius: 0 0 1.5rem 1.5rem;
        padding: 2rem 0 1.5rem 0;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
      }
      .dashboard-card {
        border-radius: 1.5rem;
        box-shadow: 0 4px 24px rgba(13, 59, 102, 0.08);
        transition: transform 0.2s;
      }
      .dashboard-card:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 32px rgba(13, 59, 102, 0.12);
      }
      .avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        box-shadow: 0 2px 8px rgba(13, 59, 102, 0.1);
        margin-bottom: 1rem;
      }
      .logout-btn {
        position: absolute;
        top: 2rem;
        right: 2rem;
      }
      @media (max-width: 576px) {
        .logout-btn {
          top: 1rem;
          right: 1rem;
        }
      }

      /* New styles for logout confirmation */
      .logout-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .logout-confirmation {
        background-color: white;
        border-radius: 1.5rem;
        padding: 2rem;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(13, 59, 102, 0.2);
      }

      .logout-icon {
        font-size: 3rem;
        color: #dc3545;
        margin-bottom: 1rem;
      }

      .logout-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .logout-buttons .btn {
        border-radius: 2rem;
        padding: 0.5rem 1.5rem;
        min-width: 100px;
      }

      .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
      }

      .toast {
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        overflow: hidden;
      }
    </style>
  </head>
  <body class="bg-light">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <a href="#" class="btn btn-outline-light logout-btn" id="logoutButton">
        <i class="bi bi-box-arrow-right"></i> Logout
      </a>
      <img
        src="{% static 'myapp/images/jobSearchMasterLogo.png' %}"
        alt="Logo"
        class="avatar mb-2"
      />
      <h1 class="fw-bold mb-1">Welcome, {{ user.username }}!</h1>
      <p class="lead mb-0">
        Hereâ€™s a quick overview of your job search journey.
      </p>
    </div>

    <!-- Dashboard Content -->
    <div class="container">
      <div class="row g-4">
        <div class="col-md-4">
          <div class="card dashboard-card text-center p-4">
            <span class="fs-1 text-primary mb-2"
              ><i class="bi bi-briefcase"></i
            ></span>
            <h5 class="fw-bold mb-1">Applications</h5>
            <p class="mb-0">
              You have
              <span class="fw-bold text-primary">{{ applications_count }}</span>
              job applications.
            </p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card dashboard-card text-center p-4">
            <span class="fs-1 text-success mb-2"
              ><i class="bi bi-check-circle"></i
            ></span>
            <h5 class="fw-bold mb-1">Interviews</h5>
            <p class="mb-0">
              Upcoming interviews:
              <span class="fw-bold text-success">{{ interviews_count }}</span>
            </p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card dashboard-card text-center p-4">
            <span class="fs-1 text-warning mb-2"
              ><i class="bi bi-star"></i
            ></span>
            <h5 class="fw-bold mb-1">Wishlist</h5>
            <p class="mb-0">
              Jobs in wishlist:
              <span class="fw-bold text-warning">{{ wishlist_count }}</span>
            </p>
          </div>
        </div>
      </div>
      <div class="text-center mt-5">
        <a
          href="{% url 'home' %}"
          class="btn btn-outline-primary rounded-pill px-4"
          >Back to Home</a
        >
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="logout-modal" id="logoutModal">
      <div class="logout-confirmation">
        <div class="logout-icon">
          <i class="bi bi-question-circle"></i>
        </div>
        <h4 class="mb-3">Confirm Logout</h4>
        <p>Are you sure you want to log out of your account?</p>
        <div class="logout-buttons">
          <button class="btn btn-secondary" id="cancelLogout">Cancel</button>
          <button class="btn btn-danger" id="confirmLogout">Log Out</button>
        </div>
      </div>
    </div>

    <!-- Toast Container for Notifications -->
    <div class="toast-container">
      <div
        class="toast align-items-center text-white bg-success border-0"
        id="successToast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-check-circle me-2"></i> Logout successful!
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
      <div
        class="toast align-items-center text-white bg-danger border-0"
        id="errorToast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-exclamation-triangle me-2"></i> Logout failed!
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <script>
      // Get DOM elements
      const logoutButton = document.getElementById("logoutButton");
      const logoutModal = document.getElementById("logoutModal");
      const cancelLogout = document.getElementById("cancelLogout");
      const confirmLogout = document.getElementById("confirmLogout");
      const successToast = document.getElementById("successToast");
      const errorToast = document.getElementById("errorToast");

      // Show logout confirmation modal
      logoutButton.addEventListener("click", function (e) {
        e.preventDefault();
        logoutModal.style.display = "flex";
      });

      // Hide modal when cancel is clicked
      cancelLogout.addEventListener("click", function () {
        logoutModal.style.display = "none";
      });

      // Hide modal when clicking outside the modal
      logoutModal.addEventListener("click", function (e) {
        if (e.target === logoutModal) {
          logoutModal.style.display = "none";
        }
      });

      // Function to get a cookie by name
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      // Function to show toast notification
      function showToast(toastElement, message = "") {
        if (message) {
          toastElement.querySelector(".toast-body").innerHTML = message;
        }
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
      }

      // Logout function
      confirmLogout.addEventListener("click", async function () {
        try {
          // Get access token from cookie
          const accessToken = getCookie("access_token");
          if (!accessToken) {
            showToast(
              errorToast,
              '<i class="bi bi-exclamation-triangle me-2"></i> No access token found!'
            );
            return;
          }

          // Make logout request with authentication
          const response = await fetch("/api/logout/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
              Authorization: `Bearer ${accessToken}`, // Add authorization header
            },
            credentials: "include",
          });

          if (response.ok) {
            // Show success toast
            showToast(successToast);

            // Close the modal
            logoutModal.style.display = "none";

            // Clear access token cookie
            document.cookie =
              "access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

            // Redirect to login page after a delay
            setTimeout(() => {
              window.location.href = "/login/";
            }, 1500);
          } else {
            // Handle specific error cases
            if (response.status === 401) {
              showToast(
                errorToast,
                '<i class="bi bi-exclamation-triangle me-2"></i> Session expired. Please login again.'
              );
              setTimeout(() => {
                window.location.href = "/login/";
              }, 2000);
            } else {
              showToast(
                errorToast,
                `<i class="bi bi-exclamation-triangle me-2"></i> Logout failed (${response.status})`
              );
            }
          }
        } catch (error) {
          console.error("Logout error:", error);
          showToast(
            errorToast,
            '<i class="bi bi-exclamation-triangle me-2"></i> Network error during logout'
          );
        }
      });

      // Initialize Bootstrap Toasts
      const successToastInstance = new bootstrap.Toast(successToast, {
        autohide: true,
        delay: 3000,
      });

      const errorToastInstance = new bootstrap.Toast(errorToast, {
        autohide: true,
        delay: 5000,
      });
    </script>
  </body>
</html>
